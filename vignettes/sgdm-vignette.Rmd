---
title: "sgdm: an R package for performing sparse generalized dissimilarity modeling, with tools for gdm"
author: "Pedro J. LeitÃ£o, Marcel Schwieder, Cornelius Senf"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sgdm-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

## Installing the model

```{r, fig.show='hold'}
#library(devtools)
#devtools::install_git(...)
library(sgdm)
```

## Test data

```{r}
head(bioData)
```


```{r}
head(predData)
```

## Running a `sgdm` model

Train model...

```{r}
sgdm.gs <- sgdm.train(predData, bioData, comps = 30)
```

Returns a performance matrix...

```{r}
print(sgdm.gs, digits = 4)
```

Extract best...

```{r}
sgdm.sccbest <- sgdm.best(sgdm.gs, predData, bioData, output = "c", comps = 30)
```

Create spData from best...

```{r}
spData.best <- gdm::formatsitepair(bioData, 1, dist = "bray", abundance = TRUE,
               siteColumn = "Plot_ID", XColumn = "X",YColumn = "Y",
               predData = sgdm.sccbest)
```

Retrain model...

```{r}
sgdm.model <- gdm::gdm(spData.best)
```

Model diagnostics

```{r}
sgdm.model$explained
```

```{r}
plot(sgdm.model$predicted, sgdm.model$observed,xlim = c(0, 1), ylim = c(0, 1))
abline(0, 1)
```

```{r}
(cor(sgdm.model$predicted, sgdm.model$observed)^2) * 100
```

Evaluate model performance

```{r}
gdm.cv(spData.best, nfolds = 10)
```

Using $r^2$

```{r}
gdm.cv(spData.best, nfolds = 10, performance = "r2")
```

Reduce model by dropping insignificant varaibles

```{r}
#sigtest.sgdm <- gdm::gdm.varImp(spData.best, geo = FALSE, fullModelOnly = TRUE, nPerm = 100, 
#                                parallel = TRUE, cores = 6)
```

```{r}
#sigtest.sgdm <- sigtest.sgdm[[2]][, 1] <= 0.05
```


```{r}
#spData.red.best <- data.reduce(spData.best, datatype = "sp", sigtest.sgdm)
```

## Making spatial predictions

There is a spatial map of the predictors...

```{r}
raster::plotRGB(predMap, r = 20, g = 10, b = 2, stretch = "hist")
```

Output map

```{r}
spData <- gdm::formatsitepair(bioData, 1, dist = "bray", abundance = TRUE,
               siteColumn = "Plot_ID", XColumn = "X",YColumn = "Y",
               predData = predData)

nmds_map <- gdm.map(spData = spData, predMap = predMap, model = sgdm.model, k = 5)
```
